<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kitamura OCR Extractor</title>
  <style>
    :root { --c1:#0078d7; --c2:#005ea3; --bg:#f7f7f7; --fg:#222; --muted:#666; }
    *{ box-sizing:border-box; }
    body{ font-family:Arial,Helvetica,sans-serif; margin:16px; background:var(--bg); color:var(--fg);}
    h2{ margin:0 0 12px; font-size:20px; }
    .card{ background:#fff; padding:14px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.06); margin-bottom:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 240px; }
    input, select, textarea, button{ width:100%; max-width:520px; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; margin-top:8px; }
    textarea{ min-height:90px; }
    button{ background:var(--c1); color:#fff; border:none; cursor:pointer; }
    button:hover{ background:var(--c2); }
    .btn-secondary{ background:#555; }
    .muted{ color:var(--muted); font-size:13px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    #status{ margin-bottom:6px; }
    dialog{ width:min(680px,92vw); border:none; border-radius:12px; padding:0; }
    dialog::backdrop{ background:rgba(0,0,0,.35); }
    .modal-header{ padding:12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .modal-body{ padding:12px 16px; max-height:55vh; overflow:auto; }
    .modal-footer{ padding:12px 16px; border-top:1px solid #eee; display:flex; gap:8px; justify-content:flex-end; }
    .history-item{ border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:8px; background:#fafafa; }
    .history-actions{ display:flex; gap:8px; margin-top:6px; }
    .small{ font-size:12px; }
    .pill{ display:inline-block; background:#eee; border-radius:999px; padding:4px 10px; font-size:12px; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ ã‚­ã‚¿ãƒ ãƒ© ãƒ—ãƒ©ã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ OCR æŠ½å‡º</h2>

  <div class="card">
    <div class="row">
      <input type="file" id="imageInput" accept="image/*" />
      <select id="condition">
        <option value="">Select Condition</option>
        <option>Unused</option>
        <option>TOP MINT</option>
        <option>MINT</option>
        <option>NEAR MINT+++</option>
        <option>NEAR MINT</option>
        <option>EXCELLENT5</option>
        <option>EXCELLENT3</option>
        <option>AS IS/For PARTS</option>
      </select>
      <input type="number" id="priceUSD" placeholder="Expected Price (USD)" />
      <textarea id="note" placeholder="Notes"></textarea>
    </div>
    <div class="actions">
      <button id="extractBtn">Extract Info</button>
      <button id="copyBtn" class="btn-secondary" style="display:none;">ğŸ“‹ ä¿®æ­£å¾Œã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button id="saveHistoryBtn" class="btn-secondary" style="display:none;">ğŸ’¾ ã“ã®çµæœã‚’å±¥æ­´ã«ä¿å­˜</button>
      <button id="openHistoryBtn" class="btn-secondary">ğŸ•˜ å±¥æ­´ï¼ˆ30ä»¶ï¼‰</button>
      <button id="exportSheetBtn" class="btn-secondary">ğŸ§¾ ãã®æ—¥åˆ†ã‚’ã‚·ãƒ¼ãƒˆã«ä¸€æ‹¬è»¢è¨˜</button>
    </div>
  </div>

  <div id="resultBox" class="card">
    <div id="status" class="muted">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    <textarea id="editableOutput" placeholder="æŠ½å‡ºçµæœã‚’ã“ã“ã§ä¿®æ­£ã§ãã¾ã™ï¼ˆCSV 1è¡Œï¼š å•†å“å, ä¾¡æ ¼, Condition, USD, ãƒ¡ãƒ¢ ï¼‰"></textarea>
    <div class="small muted">* ä¾¡æ ¼ã¯è‡ªå‹•çš„ã«ã€Œ49800ã€ã®ã‚ˆã†ã«æ•°å­—ã®ã¿ã«ãªã‚Šã¾ã™ã€‚</div>
  </div>

  <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="historyModal">
    <div class="modal-header">
      <strong>ğŸ“œ æŠ½å‡ºå±¥æ­´ï¼ˆæœ€å¤§30ä»¶ï¼‰</strong>
      <span class="pill" id="histCount">0 items</span>
    </div>
    <div class="modal-body" id="historyList"></div>
    <div class="modal-footer">
      <button id="copyAllHistoryBtn" class="btn-secondary">ğŸ“‹ ä¸€æ‹¬ã‚³ãƒ”ãƒ¼ï¼ˆCSVï¼‰</button>
      <button id="clearHistoryBtn" class="btn-secondary">ğŸ§¹ å…¨å‰Šé™¤</button>
      <button id="closeHistoryBtn">é–‰ã˜ã‚‹</button>
    </div>
  </dialog>

  <script>
async function cleanBase64(dataURL) {
  if (!dataURL) return "";
  if (dataURL.startsWith("data:image/heic") || dataURL.startsWith("data:image/heif")) {
    try {
      const img = await createImageBitmap(await (await fetch(dataURL)).blob());
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      dataURL = canvas.toDataURL("image/jpeg", 0.92);
    } catch(e) {
      console.warn("HEICå¤‰æ›ã«å¤±æ•—ï¼ˆãã®ã¾ã¾é€ä¿¡ï¼‰", e);
    }
  }
  return dataURL.replace(/[\n\r]/g, "").replace(/\s/g, "").trim();
}
    
    const GAS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxxPGc2rPb7s7Lm6ICPMG3oYmnCiVzdJSrWRCbPFJWSCJib_INXrMrI926APm72VDWpKA/exec";

    const HISTORY_KEY = "kitamura_ocr_history_v1";
    const HISTORY_LIMIT = 30;

    const els = {
      imageInput: document.getElementById("imageInput"),
      condition: document.getElementById("condition"),
      priceUSD: document.getElementById("priceUSD"),
      note: document.getElementById("note"),
      extractBtn: document.getElementById("extractBtn"),
      copyBtn: document.getElementById("copyBtn"),
      saveHistoryBtn: document.getElementById("saveHistoryBtn"),
      openHistoryBtn: document.getElementById("openHistoryBtn"),
      exportSheetBtn: document.getElementById("exportSheetBtn"),
      status: document.getElementById("status"),
      editableOutput: document.getElementById("editableOutput"),
      historyModal: document.getElementById("historyModal"),
      historyList: document.getElementById("historyList"),
      histCount: document.getElementById("histCount"),
      clearHistoryBtn: document.getElementById("clearHistoryBtn"),
      closeHistoryBtn: document.getElementById("closeHistoryBtn"),
      copyAllHistoryBtn: document.getElementById("copyAllHistoryBtn"),
    };

    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]"); }catch{ return []; } }
    function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }

    function addToHistory(entry){
      const hist = loadHistory();
      hist.unshift(entry);
      if (hist.length > HISTORY_LIMIT) hist.length = HISTORY_LIMIT;
      saveHistory(hist);
    }

    function parseCsvLine(line){
      const p = (line||"").split(",").map(s=>s.trim());
      const [name="", price="", cond="", usd="", memo=""] = p.concat(["","","","",""]).slice(0,5);
      return { name, price, cond, usd, memo };
    }

    function renderHistory(){
      const hist = loadHistory();
      els.histCount.textContent = `${hist.length} items`;
      els.historyList.innerHTML = "";
      hist.forEach((h, idx)=>{
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <div><strong>${h.name || "(no title)"}</strong></div>
          <div class="small muted">${h.price || "-"} ï½œ ${h.cond || "-"} ï½œ USD: ${h.usd || "-"}</div>
          <div class="small muted">${h.memo || ""}</div>
          <div class="history-actions">
            <button data-idx="${idx}" data-act="use">â†© ç·¨é›†æ¬„ã«åæ˜ </button>
            <button data-idx="${idx}" data-act="copy" class="btn-secondary">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button data-idx="${idx}" data-act="del" class="btn-secondary">ğŸ—‘ å‰Šé™¤</button>
          </div>
        `;
        els.historyList.appendChild(div);
      });
    }

    els.openHistoryBtn.onclick = ()=>{ renderHistory(); els.historyModal.showModal(); };
    els.closeHistoryBtn.onclick = ()=> els.historyModal.close();

    els.clearHistoryBtn.onclick = ()=>{ if(confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ saveHistory([]); renderHistory(); }};

    els.historyList.onclick = (e)=>{
      const btn = e.target.closest("button"); if(!btn) return;
      const idx = Number(btn.dataset.idx), act = btn.dataset.act;
      const hist = loadHistory(), h = hist[idx]; if(!h) return;
      const csv = `${h.name}, ${h.price}, ${h.cond}, ${h.usd}, ${h.memo}`;
      if(act==="use"){ els.editableOutput.value = csv; els.status.textContent="â†© å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã¿"; els.historyModal.close(); }
      else if(act==="copy"){ navigator.clipboard.writeText(csv); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!"); }
      else if(act==="del"){ hist.splice(idx,1); saveHistory(hist); renderHistory(); }
    };

    els.copyAllHistoryBtn.onclick = ()=>{
      const hist = loadHistory();
      if(!hist.length){ alert("å±¥æ­´ãŒç©ºã§ã™"); return; }
      const all = hist.map(h=>`${h.name}, ${h.price}, ${h.cond}, ${h.usd}, ${h.memo}`).join("\n");
      navigator.clipboard.writeText(all).then(()=>alert("ğŸ“‹ å…¨ä»¶ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!"));
    };

    els.extractBtn.onclick = async ()=>{
      const file = els.imageInput.files?.[0];
      if (!file){ alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      els.status.textContent = "ğŸ”„ èªè­˜ä¸­...";
      els.copyBtn.style.display = "none"; els.saveHistoryBtn.style.display = "none";

      const reader = new FileReader();
      reader.onload = async ()=>{
        const base64 = await cleanBase64(reader.result);
        try{
          const r = await fetch("/.netlify/functions/openai-function",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ imageBase64: base64 })
          });
          const data = await r.json();

          let name = data?.å•†å“?.åå‰ || "ä¸æ˜";
          let priceJP = data?.å•†å“?.ä¾¡æ ¼ || "0";
          priceJP = priceJP.replace(/[^\d]/g,""); // â† æ•°å­—ã ã‘æ®‹ã™ï¼

          const cond = els.condition.value || "";
          const usd  = els.priceUSD.value || "";
          const memo = els.note.value || "";

          const csv = `${name}, ${priceJP}, ${cond}, ${usd}, ${memo}`;
          els.editableOutput.value = csv;
          els.status.textContent = "âœ… æŠ½å‡ºå®Œäº†";
          els.copyBtn.style.display = "inline-block";
          els.saveHistoryBtn.style.display = "inline-block";

        }catch(err){
          els.status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + err.message;
        }
      };
      reader.readAsDataURL(file);
    };

    els.copyBtn.onclick = ()=> navigator.clipboard.writeText(els.editableOutput.value).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!"));

    els.saveHistoryBtn.onclick = ()=>{
      const { name, price, cond, usd, memo } = parseCsvLine(els.editableOutput.value);
      if (!name){ alert("å•†å“åãŒç©ºã§ã™"); return; }
      addToHistory({ name, price, cond, usd, memo });
      els.status.textContent = "ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸ";
    };

    els.exportSheetBtn.onclick = async ()=>{
      const hist = loadHistory();
      if (!hist.length){ alert("å±¥æ­´ãŒç©ºã§ã™"); return; }
      if (!GAS_WEBHOOK_URL.includes("http")){ alert("GAS URLæœªè¨­å®š"); return; }
      const payload = hist.map(h=>({
        name: h.name,
        priceJPY: h.price,
        cond: h.cond || "",
        usd : (h.usd ?? "").toString().trim(),
        memo: h.memo || ""
      }));
      try{
        const r = await fetch(GAS_WEBHOOK_URL,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ entries: payload })
        });
        const j = await r.json();
        if (j.ok){
          alert(`ğŸ§¾ ${j.added}ä»¶è¿½åŠ ã—ã¾ã—ãŸ`);
          saveHistory([]); // è»¢è¨˜å¾Œå‰Šé™¤
        } else {
          alert("è»¢è¨˜å¤±æ•—: " + (j.error || ""));
        }
      }catch(e){
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    };
  </script>
</body>
</html>

