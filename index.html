<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kitamura OCR Extractor</title>
  <style>
    :root { --c1:#0078d7; --c2:#005ea3; --bg:#f7f7f7; --fg:#222; --muted:#666; }
    *{ box-sizing:border-box; }
    body{ font-family:Arial,Helvetica,sans-serif; margin:16px; background:var(--bg); color:var(--fg); }
    h2{ margin:0 0 12px; font-size:20px; }
    .card{ background:#fff; padding:14px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.06); margin-bottom:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 240px; }
    input, select, textarea, button{
      width:100%; max-width:520px; padding:10px; font-size:16px;
      border:1px solid #ccc; border-radius:8px; margin-top:8px;
    }
    textarea{ min-height:90px; }
    button{ background:var(--c1); color:#fff; border:none; cursor:pointer; }
    button:hover{ background:var(--c2); }
    .btn-secondary{ background:#555; }
    .muted{ color:var(--muted); font-size:13px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    #status{ margin-bottom:6px; }
    dialog{ width:min(680px,92vw); border:none; border-radius:12px; padding:0; }
    dialog::backdrop{ background:rgba(0,0,0,.35); }
    .modal-header{ padding:12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .modal-body{ padding:12px 16px; max-height:55vh; overflow:auto; }
    .modal-footer{ padding:12px 16px; border-top:1px solid #eee; display:flex; gap:8px; justify-content:flex-end; }
    .history-item{ border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:8px; background:#fafafa; }
    .history-actions{ display:flex; gap:8px; margin-top:6px; }
    .small{ font-size:12px; }
    .pill{ display:inline-block; background:#eee; border-radius:999px; padding:4px 10px; font-size:12px; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ ã‚­ã‚¿ãƒ ãƒ© ãƒ—ãƒ©ã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ OCR æŠ½å‡º</h2>

  <div class="card">
    <div class="row">
      <input type="file" id="imageInput" accept="image/*" />
      <select id="condition">
        <option value="">Select Condition</option>
        <option>Unused</option>
        <option>TOP MINT</option>
        <option>MINT</option>
        <option>NEAR MINT+++</option>
        <option>NEAR MINT</option>
        <option>EXCELLENT5</option>
        <option>EXCELLENT3</option>
        <option>AS IS/For PARTS</option>
      </select>
      <input type="number" id="priceUSD" placeholder="Expected Price (USD)" />
      <textarea id="note" placeholder="Notes"></textarea>
    </div>
    <div class="actions">
      <button id="extractBtn">Extract Info</button>
      <button id="copyBtn" class="btn-secondary" style="display:none;">ğŸ“‹ ä¿®æ­£å¾Œã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button id="saveHistoryBtn" class="btn-secondary" style="display:none;">ğŸ’¾ ã“ã®çµæœã‚’å±¥æ­´ã«ä¿å­˜</button>
      <button id="openHistoryBtn" class="btn-secondary">ğŸ•˜ å±¥æ­´ï¼ˆ30ä»¶ï¼‰</button>
      <button id="exportSheetBtn" class="btn-secondary">ğŸ§¾ ãã®æ—¥åˆ†ã‚’ã‚·ãƒ¼ãƒˆã«ä¸€æ‹¬è»¢è¨˜</button>
    </div>
  </div>

  <div id="resultBox" class="card">
    <div id="status" class="muted">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    <textarea id="editableOutput" placeholder="æŠ½å‡ºçµæœã‚’ã“ã“ã§ä¿®æ­£ã§ãã¾ã™ï¼ˆCSV 1è¡Œï¼š å•†å“å, ç¨è¾¼ä¾¡æ ¼, Condition, USD, ãƒ¡ãƒ¢ ï¼‰"></textarea>
    <div class="small muted">* ç¨è¾¼ä¾¡æ ¼ã¯ã€Œç¨è¾¼49,800å††ã€ã®ã‚ˆã†ã«æŠ½å‡ºã•ã‚Œã¾ã™ãŒã€ã‚·ãƒ¼ãƒˆè»¢è¨˜æ™‚ã«ã€Œ49800ã€ã«è‡ªå‹•å¤‰æ›ã—ã¾ã™ã€‚</div>
  </div>

  <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="historyModal">
    <div class="modal-header">
      <strong>ğŸ“œ æŠ½å‡ºå±¥æ­´ï¼ˆæœ€å¤§30ä»¶ï¼‰</strong>
      <span class="pill" id="histCount">0 items</span>
    </div>
    <div class="modal-body" id="historyList"></div>
    <div class="modal-footer">
      <button id="clearHistoryBtn" class="btn-secondary">ğŸ§¹ å…¨å‰Šé™¤</button>
      <button id="closeHistoryBtn">é–‰ã˜ã‚‹</button>
    </div>
  </dialog>

  <script>
    const GAS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxj6HL0L1GBuPvXHOFqVInoTgSYJBKQLeVkAIzx_YyXGzuH7xc6abinSZRWDDST5rkNjQ/exec";

    const HISTORY_KEY = "kitamura_ocr_history_v1";
    const HISTORY_LIMIT = 30;

    const els = {
      imageInput: document.getElementById("imageInput"),
      condition: document.getElementById("condition"),
      priceUSD: document.getElementById("priceUSD"),
      note: document.getElementById("note"),
      extractBtn: document.getElementById("extractBtn"),
      copyBtn: document.getElementById("copyBtn"),
      saveHistoryBtn: document.getElementById("saveHistoryBtn"),
      openHistoryBtn: document.getElementById("openHistoryBtn"),
      exportSheetBtn: document.getElementById("exportSheetBtn"),
      status: document.getElementById("status"),
      editableOutput: document.getElementById("editableOutput"),
      historyModal: document.getElementById("historyModal"),
      historyList: document.getElementById("historyList"),
      histCount: document.getElementById("histCount"),
      clearHistoryBtn: document.getElementById("clearHistoryBtn"),
      closeHistoryBtn: document.getElementById("closeHistoryBtn"),
    };

    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]"); }catch{ return []; } }
    function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
    function addToHistory(entry){
      const hist = loadHistory();
      hist.unshift(entry);
      if (hist.length > HISTORY_LIMIT) hist.length = HISTORY_LIMIT;
      saveHistory(hist);
    }
    function parseCsvLine(line){
      const parts = (line||"").split(",").map(s=>s.trim());
      const [name="", priceJP="", cond="", usd="", memo=""] = parts.concat(["","","","",""]).slice(0,5);
      return { name, priceJP, cond, usd, memo };
    }
    function renderHistory(){
      const hist = loadHistory();
      els.histCount.textContent = `${hist.length} items`;
      els.historyList.innerHTML = "";
      hist.forEach((h, idx)=>{
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <div><strong>${h.name || "(no title)"}</strong></div>
          <div class="small muted">${h.priceJP || "-"} ï½œ ${h.cond || "-"} ï½œ USD: ${h.usd || "-"}</div>
          <div class="small muted">${h.memo || ""}</div>
          <div class="history-actions">
            <button data-idx="${idx}" data-act="use">â†© ã“ã®å†…å®¹ã‚’ç·¨é›†æ¬„ã«åæ˜ </button>
            <button data-idx="${idx}" data-act="copy" class="btn-secondary">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button data-idx="${idx}" data-act="del" class="btn-secondary">ğŸ—‘ å‰Šé™¤</button>
          </div>
        `;
        els.historyList.appendChild(div);
      });
    }
    els.openHistoryBtn.onclick = ()=>{ renderHistory(); els.historyModal.showModal(); };
    els.closeHistoryBtn.onclick = ()=> els.historyModal.close();
    els.clearHistoryBtn.onclick = ()=>{
      if (!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      saveHistory([]); renderHistory();
    };
    els.historyList.onclick = (e)=>{
      const btn = e.target.closest("button"); if(!btn) return;
      const idx = Number(btn.dataset.idx); const act = btn.dataset.act;
      const hist = loadHistory(); const h = hist[idx]; if(!h) return;
      const csv = `${h.name}, ${h.priceJP}, ${h.cond}, ${h.usd}, ${h.memo}`;
      if (act==="use"){ els.editableOutput.value = csv; els.status.textContent="â†© å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚"; els.historyModal.close(); }
      else if (act==="copy"){ navigator.clipboard.writeText(csv).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼")).catch(()=>alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")); }
      else if (act==="del"){ hist.splice(idx,1); saveHistory(hist); renderHistory(); }
    };

    function jpPriceToNumber(priceJP){
      if (!priceJP) return "";
      const digits = String(priceJP).replace(/[^\d]/g,"");
      return digits || "";
    }

    els.extractBtn.onclick = async function(){
      const file = els.imageInput.files?.[0];
      if (!file){ alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const reader = new FileReader();
      reader.onload = async ()=>{
        const base64Image = reader.result;
        els.status.textContent = "ğŸ”„ èªè­˜ä¸­...";
        els.copyBtn.style.display = "none";
        els.saveHistoryBtn.style.display = "none";

        try{
          const res = await fetch("/.netlify/functions/openai-function",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ imageBase64: base64Image })
          });
          const data = await res.json();

          const name = data?.å•†å“?.åå‰ || "ä¸æ˜";
          const priceJP = data?.å•†å“?.ä¾¡æ ¼ || "ç¨è¾¼0å††";
          const cond = els.condition.value || "";
          const usd  = els.priceUSD.value || "";
          const memo = els.note.value || "";

          const csv = `${name}, ${priceJP}, ${cond}, ${usd}, ${memo}`;
          els.editableOutput.value = csv;
          els.status.textContent = "âœ… æŠ½å‡ºå®Œäº†ï¼ˆç·¨é›†â†’ä¿å­˜â†’ã‚³ãƒ”ãƒ¼ï¼ä¸€æ‹¬è»¢è¨˜ã§ãã¾ã™ï¼‰";
          els.copyBtn.style.display = "inline-block";
          els.saveHistoryBtn.style.display = "inline-block";
        }catch(err){
          els.status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + err.message;
        }
      };
      reader.readAsDataURL(file);
    };

    els.copyBtn.onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(els.editableOutput.value);
        alert("ğŸ“‹ ä¿®æ­£å¾Œã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
      }catch{
        alert("âš ï¸ è‡ªå‹•ã‚³ãƒ”ãƒ¼ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
      }
    };

    els.saveHistoryBtn.onclick = ()=>{
      const { name, priceJP, cond, usd, memo } = parseCsvLine(els.editableOutput.value);
      if (!name){ alert("å•†å“åãŒç©ºã§ã™ã€‚ç·¨é›†æ¬„ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); return; }
      addToHistory({ name, priceJP, cond, usd, memo });
      els.status.textContent = "ğŸ’¾ å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸã€‚";
    };

    els.exportSheetBtn.onclick = async ()=>{
      const hist = loadHistory();
      if (!hist.length){ alert("å±¥æ­´ãŒç©ºã§ã™ã€‚ã¾ãšæŠ½å‡ºã—ã¦ã€ä¿å­˜ã€ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (!GAS_WEBHOOK_URL){
        alert("GASã®Webã‚¢ãƒ—ãƒªURLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      const payload = hist.map(h=>({
        name: h.name,
        priceJPY: jpPriceToNumber(h.priceJP),
        cond: h.cond || "",
        usd : (h.usd ?? "").toString().trim(),
        memo: h.memo || ""
      }));

      try{
        await fetch(GAS_WEBHOOK_URL,{
          method:"POST",
          mode: "no-cors",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ entries: payload })
        });

        alert(`ğŸ§¾ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸é€ä¿¡ã—ã¾ã—ãŸã€‚ï¼ˆiPhoneã®ãŸã‚çµæœã¯ç¢ºèªã§ãã¾ã›ã‚“ãŒæˆåŠŸã—ã¦ã„ã¾ã™ï¼‰`);

        saveHistory([]);
        els.status.textContent = "âœ… ã‚·ãƒ¼ãƒˆè»¢è¨˜å®Œäº†ï¼ˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼‰";

      }catch(e){
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼(no-corsç‰ˆ): " + e.message);
      }
    };
  </script>
</body>
</html>
