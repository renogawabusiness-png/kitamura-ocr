<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kitamura OCR Extractor</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    h2 { color: #333; }
    input, select, button, textarea { font-size: 16px; margin: 6px 0; padding: 6px; width: 100%; max-width: 400px; }
    button { background: #0078d7; color: white; border: none; border-radius: 6px; cursor: pointer; padding: 10px; }
    button:hover { background: #005ea3; }
    textarea { height: 80px; }
    #resultBox { margin-top: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 6px rgba(0,0,0,0.1); }
    #editableOutput { width: 100%; height: 90px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; padding: 6px; }
  </style>
</head>
<body>
  <h2>📸 キタムラプライスカード情報抽出</h2>
  <input type="file" id="imageInput" accept="image/*"><br>
  <select id="condition">
    <option value="">Select Condition</option>
    <option>Unused</option>
    <option>TOP MINT</option>
    <option>MINT</option>
    <option>NEAR MINT+++</option>
    <option>NEAR MINT</option>
    <option>EXCELLENT5</option>
    <option>EXCELLENT3</option>
    <option>AS IS/For PARTS</option>
  </select><br>
  <input type="number" id="price" placeholder="Expected Price (USD)"><br>
  <textarea id="note" placeholder="Notes"></textarea><br>
  <button id="extractBtn">Extract Info</button>

  <div id="resultBox">
    <div id="result">結果がここに表示されます</div>
    <textarea id="editableOutput" placeholder="抽出結果をここで修正できます"></textarea><br>
    <button id="copyBtn" style="display:none;">📋 修正後の内容をコピー</button>
  </div>

  <script>
    document.getElementById("extractBtn").onclick = async function processImage() {
      const fileInput = document.getElementById("imageInput");
      if (!fileInput.files.length) return alert("画像を選択してください");
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = async function () {
        const imageBase64 = reader.result;
        document.getElementById("result").innerText = "🔄 認識中...";
        document.getElementById("editableOutput").value = "";
        document.getElementById("copyBtn").style.display = "none";
        try {
          const res = await fetch("/.netlify/functions/openai-function", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ imageBase64 })
          });
          const result = await res.json();
          console.log("✅ AIからの最終レスポンス:", result);

          const name = result.商品?.名前 || "不明";
          const priceJP = result.商品?.価格 || "不明";
          const condition = document.getElementById("condition").value || "";
          const priceUSD = document.getElementById("price").value || "";
          const note = document.getElementById("note").value || "";

          const output = `${name}, ${priceJP}, ${condition}, ${priceUSD}, ${note}`;
          document.getElementById("result").innerText = "✅ 抽出完了（修正できます）";
          document.getElementById("editableOutput").value = output;
          document.getElementById("copyBtn").style.display = "inline-block";

        } catch (err) {
          document.getElementById("result").innerText = "❌ エラー: " + err.message;
        }
      };
    };

    document.getElementById("copyBtn").onclick = async function () {
      const text = document.getElementById("editableOutput").value;
      try {
        await navigator.clipboard.writeText(text);
        alert("📋 修正後の内容をコピーしました！\n" + text);
      } catch {
        alert("⚠️ 自動コピーがブロックされました。手動でコピーしてください。");
      }
    };
  </script>
</body>
</html>
